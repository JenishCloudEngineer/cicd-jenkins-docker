pipeline {
  agent any

  environment {
    IMAGE_NAME = "cicd-app"
    IMAGE_TAG  = "${env.BUILD_NUMBER}"
    DOCKER_CREDS = "DockerCred"              // DockerHub credentials ID
    DOCKER_NETWORK = "cicd_jenkins_docker_cicdnet"  // Compose-created network
  }

  stages {

    stage('Clean Workspace') {
      steps {
        deleteDir()
      }
    }

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        dir('app') {
          sh 'npm install'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('app') {
          sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
        }
      }
    }

    stage('Run Tests') {
      steps {
        dir('app') {

          sh 'docker rm -f test-container || true'

          sh """
            docker run -d \
              --network ${DOCKER_NETWORK} \
              --name test-container \
              -p 3000:3000 \
              ${IMAGE_NAME}:${IMAGE_TAG}
          """

          sh 'sleep 4'
          sh 'docker logs test-container || true'

          script {
            sh "node test.js test-container"
          }

          sh 'docker rm -f test-container || true'
        }
      }
    }

    stage('Deploy Preview') {
      steps {
        echo "Deploying preview container on port 3001..."

        sh 'docker rm -f preview-container || true'

        sh """
          docker run -d \
            --network ${DOCKER_NETWORK} \
            --name preview-container \
            -p 3001:3000 \
            ${IMAGE_NAME}:${IMAGE_TAG}
        """

        echo "Preview available at: http://localhost:3001"
      }
    }

    stage('Push to DockerHub') {
      when {
        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
      }
      steps {
        withCredentials([
          usernamePassword(credentialsId: DOCKER_CREDS, usernameVariable: 'USER', passwordVariable: 'PASS')
        ]) {
          sh "echo \$PASS | docker login -u \$USER --password-stdin"
          sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} \$USER/${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker push \$USER/${IMAGE_NAME}:${IMAGE_TAG}"
        }
      }
    }
  }

  post {

    success {
      echo "BUILD SUCCESS #${env.BUILD_NUMBER}"

      // EMAIL SUCCESS NOTIFICATION
      emailext(
        to: "jenishjk98@gmail.com",
        subject: "Jenkins Build SUCCESS #${env.BUILD_NUMBER}",
        body: """
          Your Jenkins Pipeline Build was SUCCESSFUL!

        Build Number: ${env.BUILD_NUMBER}
        Project: cicd-jenkins-docker
        Docker Image: ${IMAGE_NAME}:${IMAGE_TAG}

        Preview App Available At:
        http://localhost:3001

        Regards,
        Jenkins CI/CD Pipeline
        """
      )
    }

    failure {
      echo "BUILD FAILED #${env.BUILD_NUMBER}"

      // EMAIL FAILURE NOTIFICATION
      emailext(
        to: "jenishjk98@gmail.com",
        subject: " Jenkins Build FAILED #${env.BUILD_NUMBER}",
        body: """
        ⚠️ Your Jenkins Pipeline Build FAILED!

        Build Number: ${env.BUILD_NUMBER}
        Please check Jenkins console logs for more details.

        Regards,
        Jenkins CI/CD Pipeline
        """
      )
    }

    always {
      sh 'docker rm -f test-container || true'
    }
  }
}
