pipeline {
  agent any

  environment {
    IMAGE_NAME = "cicd-app"
    IMAGE_TAG = "${env.BUILD_NUMBER}"

    GITHUB_CREDS = "github-creds"
    DOCKER_CREDS = "dockerhub-creds"
    SLACK_CREDS = "slack-webhook"
  }

  stages {
    stage("Checkout") {
      steps {
        checkout scm
      }
    }

    stage("Install Dependencies") {
      steps {
        dir("app") {
          sh "npm install"
        }
      }
    }

    stage("Build Docker Image") {
      steps {
        dir("app") {
          sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
        }
      }
    }

    stage("Run Tests") {
      steps {
        dir("app") {
          sh "docker rm -f test-container || true"
          sh "docker run -d --name test-container -p 3000:3000 ${IMAGE_NAME}:${IMAGE_TAG}"
          sh "sleep 3"
          sh "node test.js"
        }
      }
    }

    stage("Push to DockerHub") {
      steps {
        withCredentials([usernamePassword(credentialsId: DOCKER_CREDS, usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
          sh "echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin"
          sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} $DOCKER_USERNAME/${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker push $DOCKER_USERNAME/${IMAGE_NAME}:${IMAGE_TAG}"
        }
      }
    }
  }

  post {
    success {
      withCredentials([string(credentialsId: SLACK_CREDS, variable: 'SLACK_WEBHOOK_URL')]) {
        sh """
        curl -X POST -H 'Content-type: application/json' \
        --data '{\"text\":\"Build SUCCESS #${env.BUILD_NUMBER}\"}' \
        $SLACK_WEBHOOK_URL
        """
      }
    }

    failure {
      withCredentials([string(credentialsId: SLACK_CREDS, variable: 'SLACK_WEBHOOK_URL')]) {
        sh """
        curl -X POST -H 'Content-type: application/json' \
        --data '{\"text\":\"Build FAILED #${env.BUILD_NUMBER}\"}' \
        $SLACK_WEBHOOK_URL
        """
      }
    }
  }
}

