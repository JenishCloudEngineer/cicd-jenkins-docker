pipeline {
  agent any

  environment {
    IMAGE_NAME = "cicd-app"
    IMAGE_TAG  = "${env.BUILD_NUMBER}"
    DOCKER_CREDS = "DockerCred"
    DOCKER_NETWORK = "cicd_jenkins_docker_cicdnet"
  }

  stages {

    stage('Clean Workspace') {
      steps { deleteDir() }
    }

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install Dependencies') {
      steps {
        dir('app') {
          sh 'npm install'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('app') {
          sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
        }
      }
    }

    stage('Run Tests') {
      steps {
        dir('app') {

          sh 'docker rm -f test-container || true'

          sh "docker run -d --network ${DOCKER_NETWORK} --name test-container -p 3000:3000 ${IMAGE_NAME}:${IMAGE_TAG}"

          sh 'sleep 4'
          sh 'docker logs test-container || true'

          script {
            sh "node test.js test-container"
          }

          sh 'docker rm -f test-container || true'
        }
      }
    }

    stage('Deploy Preview (Permanent Container)') {
      steps {
        echo "Starting preview container on port 3001..."

        // remove old preview container
        sh 'docker rm -f preview-container || true'

        // deploy new preview container
        sh """
            docker run -d \
              --network ${DOCKER_NETWORK} \
              --name preview-container \
              -p 3001:3000 \
              ${IMAGE_NAME}:${IMAGE_TAG}
        """

        echo "Preview is available at: http://localhost:3001"
      }
    }

    stage('Push to DockerHub') {
      when {
        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
      }
      steps {
        withCredentials([usernamePassword(credentialsId: DOCKER_CREDS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh "echo \$PASS | docker login -u \$USER --password-stdin"
          sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} \$USER/${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker push \$USER/${IMAGE_NAME}:${IMAGE_TAG}"
        }
      }
    }
  }

  post {
    success { echo "BUILD SUCCESS #${env.BUILD_NUMBER}" }
    failure { echo "BUILD FAILED #${env.BUILD_NUMBER}" }

    always {
      // test container always cleaned
      sh 'docker rm -f test-container || true'
    }
  }
}
