pipeline {
  agent any

  environment {
    IMAGE_NAME = "cicd-app"
    IMAGE_TAG  = "${env.BUILD_NUMBER}"
    DOCKER_CREDS = "DockerCred"   // change if your Docker credentials ID is different
    DOCKER_NETWORK = "cicd_jenkins_docker_cicdnet" // <-- the network you used
  }

  stages {
    stage('Clean Workspace') {
      steps { deleteDir() }
    }

    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Install Dependencies') {
      steps {
        dir('app') {
          sh 'npm install'
        }
      }
    }

    stage('Build Docker Image') {
      steps {
        dir('app') {
          // use no-cache only if you want fresh build every time; remove --no-cache to speed up repeated builds
          sh "docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ."
        }
      }
    }

    stage('Run Tests') {
      steps {
        dir('app') {
          // ensure previous test container is removed
          sh 'docker rm -f test-container || true'

          // run test container attached to same Docker network as Jenkins (compose network)
          sh "docker run -d --network ${DOCKER_NETWORK} --name test-container -p 3000:3000 ${IMAGE_NAME}:${IMAGE_TAG}"

          // wait for container to start and show logs for debug
          sh 'sleep 4'
          sh 'docker logs test-container || true'

          script {
            // use container hostname (Docker DNS works on same user-defined network)
            sh "node test.js test-container"
          }

          // cleanup local test container (optional)
          sh 'docker rm -f test-container || true'
        }
      }
    }

    stage('Push to DockerHub') {
      when {
        expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
      }
      steps {
        withCredentials([usernamePassword(credentialsId: DOCKER_CREDS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          sh "echo $PASS | docker login -u $USER --password-stdin"
          sh "docker tag ${IMAGE_NAME}:${IMAGE_TAG} $USER/${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker push $USER/${IMAGE_NAME}:${IMAGE_TAG}"
        }
      }
    }
  }

  post {
    success { echo "BUILD SUCCESS #${env.BUILD_NUMBER}" }
    failure { echo "BUILD FAILED #${env.BUILD_NUMBER}" }
    always {
      // ensure no leftover test container
      sh 'docker rm -f test-container || true'
    }
  }
}
